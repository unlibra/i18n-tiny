---
/**
 * Localized Link component for Astro
 *
 * Automatically detects whether locale prefix is needed based on current URL.
 *
 * @example
 * ```astro
 * import Link from '@i18n-tiny/astro/router/Link.astro'
 *
 * // Auto-localized (maintains current URL pattern)
 * <Link href="/about">About</Link>
 *
 * // Language switch with explicit locale
 * <Link href="/" locale="ja">日本語</Link>
 *
 * // Raw path (no localization)
 * <Link href="/" locale="">English</Link>
 * ```
 */
import type { HTMLAttributes } from 'astro/types'
import { getLinkHref } from '@i18n-tiny/core/router'

interface Props extends HTMLAttributes<'a'> {
  /** The path to navigate to */
  href: string
  /**
   * Override the locale for this link
   * - undefined: auto-localize based on current URL (default)
   * - string (e.g., 'ja'): generate path with specified locale prefix
   * - '' (empty string): use href as-is without any localization
   */
  locale?: string
}

const { href, locale, ...attrs } = Astro.props

const locals = Astro.locals as Record<string, unknown>

// Get current locale from route params or locals (for SSR rewrite mode)
const currentLocale = (Astro.params.locale as string | undefined)
  || locals.locale as string | undefined

// Use original pathname if available (for SSR rewrite mode where URL is rewritten)
const currentPathname = (locals.originalPathname as string | undefined) ?? Astro.url.pathname

const localizedHref = getLinkHref(href, currentPathname, currentLocale, locale)
---

<a href={localizedHref} {...attrs}>
  <slot />
</a>
